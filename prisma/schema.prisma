generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums for USER-DEFINED types
enum FormStatus {
  DRAFT
  PUBLISHED
  CLOSED
  ARCHIVED
}

enum FormType {
  REACH_OUT
  EMBEDDED
}

enum ResponseStatus {
  STARTED
  COMPLETED
  ABANDONED
  PARTIAL
}

enum TransactionType {
  CREDIT
  DEBIT
  TRANSFER
  RESPONSE
  REFUND
  AI_USAGE
  GIFT
}

enum AnalyticsEventType {
  FORM_OPENED
  FORM_STARTED
  FORM_SUBMITTED
}

// #region CORE MODELS
model Team {
  id        String    @id @default(uuid()) @db.Uuid
  name      String?   @db.VarChar
  ownerId   String?   @db.VarChar
  planId    String?   @db.Uuid
  valid     Boolean   @default(true) @db.Boolean
  createdAt DateTime  @default(now()) @db.Timestamptz
  updatedAt DateTime? @updatedAt @db.Timestamp
  // createdBy String?   @db.VarChar

  // Relations
  plan         Plan?         @relation(fields: [planId], references: [id], onDelete: SetNull)
  projects     Project[]
  forms        Form[]
  transactions Transaction[]
  // wallet   Wallet?

  @@map("teams")
}

model Project {
  id          String    @id @default(uuid()) @db.Uuid
  name        String    @db.Text
  description String?   @db.Text
  teamId      String    @db.Uuid
  valid       Boolean   @default(true) @db.Boolean
  createdAt   DateTime? @db.Timestamptz
  updatedAt   DateTime? @db.Timestamptz

  // Relations
  team  Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)
  forms Form[]

  @@map("projects")
}

model Form {
  id                  String      @id @default(uuid()) @db.Uuid
  name                String      @db.Text
  description         String?     @db.Text
  teamId              String      @db.Uuid
  projectId           String      @db.Uuid
  theme               String?     @db.Text
  logoUrl             String?     @db.Text
  maxResponses        Int?
  openAt              DateTime?   @db.Timestamptz
  closeAt             DateTime?   @db.Timestamptz
  type                FormType?
  status              FormStatus?
  passwordHash        String?     @db.Text
  uniqueSubdomain     String?     @db.Text
  customDomain        String?     @db.Text
  welcomeScreen       Json?       @db.JsonB
  thankYouScreen      Json?       @db.JsonB
  config              Json[]      @db.JsonB
  requireConsent      Boolean?    @db.Boolean
  allowAnonymous      Boolean?    @db.Boolean
  multipleSubmissions Boolean?    @default(false) @db.Boolean
  passwordProtected   Boolean?    @default(false) @db.Boolean
  analyticsEnabled    Boolean?    @default(true) @db.Boolean
  valid               Boolean     @default(true) @db.Boolean
  createdBy           String      @db.Text
  createdAt           DateTime?   @db.Timestamptz
  updatedAt           DateTime?   @db.Timestamptz

  // Relations
  project         Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  team            Team             @relation(fields: [teamId], references: [id], onDelete: Cascade)
  responses       Response[]
  analyticsEvents AnalyticsEvent[]

  @@map("forms")
}

model Response {
  id          String          @id @default(uuid()) @db.Uuid
  formId      String          @db.Uuid
  userId      String?         @db.Text
  data        Json            @default("{}") @db.JsonB
  metaData    Json?           @default("{}") @db.JsonB
  tags        String[]
  status      ResponseStatus?
  partialSave Boolean?        @db.Boolean
  notified    Boolean?        @db.Boolean
  valid       Boolean         @default(true) @db.Boolean
  startedAt   DateTime?       @db.Timestamptz
  submittedAt DateTime?       @db.Timestamptz
  updatedAt   DateTime?       @db.Timestamptz

  // Relations
  form Form @relation(fields: [formId], references: [id], onDelete: Cascade)

  @@map("responses")
}

model AnalyticsEvent {
  id          String              @id @default(uuid()) @db.Uuid
  formId      String              @db.Uuid
  eventType   AnalyticsEventType?
  createdAt   DateTime            @default(now()) @db.Timestamptz
  submittedAt DateTime?

  // Relations
  form Form @relation(fields: [formId], references: [id], onDelete: Cascade)

  @@map("analytics_events")
}

// #endregion

// #region WALLET, TRANSACTION, PLAN, FEATURE MODELS

// model Wallet {
//   id                     String    @id @default(uuid()) @db.Uuid
//   teamId                 String    @unique @db.Uuid
//   balance                Float     @default(0) @db.DoublePrecision
//   nonTransferableBalance Float     @default(0) @db.DoublePrecision
//   currency               String    @default("INR") @db.VarChar(3)
//   currencyRate           Float     @default(1) @db.DoublePrecision
//   createdAt              DateTime  @default(now()) @db.Timestamptz
//   updatedAt              DateTime? @updatedAt @db.Timestamptz

//   // Relations
//   transactions Transaction[]
//   team         Team          @relation(fields: [teamId], references: [id], onDelete: Cascade)

//   @@map("wallets")
// }

model Transaction {
  id          String          @id @default(uuid()) @db.Uuid
  type        TransactionType
  amount      Float           @db.DoublePrecision
  description String?         @db.Text
  createdAt   DateTime        @default(now()) @db.Timestamptz
  createdBy   String?         @db.VarChar
  teamId      String          @db.Uuid
  // walletId    String          @db.VarChar(30)

  // Relations
  // wallet Wallet @relation(fields: [walletId], references: [id])
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@map("transactions")
}

model Plan {
  id          String    @id @default(uuid()) @db.Uuid
  name        String    @db.Text
  description String?   @db.Text
  price       Float     @db.DoublePrecision
  currency    String    @default("INR") @db.VarChar(3)
  valid       Boolean   @default(true) @db.Boolean
  createdAt   DateTime  @default(now()) @db.Timestamptz
  updatedAt   DateTime? @updatedAt @db.Timestamptz

  // Relations
  features Feature[]
  teams    Team[]

  @@map("plans")
}

model Feature {
  id          String    @id @default(uuid()) @db.Uuid
  planId      String    @db.Uuid
  key         String    @db.Text
  name        String?   @db.Text
  description String?   @db.Text
  valid       Boolean   @default(true) @db.Boolean
  createdAt   DateTime  @default(now()) @db.Timestamptz
  updatedAt   DateTime? @updatedAt @db.Timestamptz

  // Relations
  plan Plan @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@map("features")
}

// #endregion

model User {
  id             String  @id @default(uuid()) @db.Uuid
  userName       String  @db.Text
  email          String  @unique @db.Text
  phoneNumber    String? @db.Text
  googleId       String? @unique @db.Text
  profilePicture String? @db.Text
  firstName      String? @db.Text
  lastName       String? @db.Text
  emailVerified  Boolean @default(false)

  createdAt DateTime @default(now()) @db.Timestamptz
  updatedAt DateTime @updatedAt @db.Timestamptz

  @@map("users")
}
