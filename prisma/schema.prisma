generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums for USER-DEFINED types
enum FormStatus {
  DRAFT
  PUBLISHED
  CLOSED
  ARCHIVED
}

enum FormType {
  REACH_OUT
  EMBEDDED
}

enum ResponseStatus {
  STARTED
  COMPLETED
  ABANDONED
  PARTIAL
}

enum TransactionType {
  CREDIT
  DEBIT
  TRANSFER
  RESPONSE
  REFUND
  AI_USAGE
  GIFT
}

// #region CORE MODELS
model Team {
  id        String    @id @default(uuid()) @db.Uuid
  name      String?   @db.VarChar
  ownerId   String?   @db.VarChar
  planId    String?   @db.Uuid
  valid     Boolean   @default(true) @db.Boolean
  createdAt DateTime  @default(now()) @db.Timestamptz
  updatedAt DateTime? @updatedAt @db.Timestamp
  // createdBy String?   @db.VarChar

  // Relations
  plan     Plan?     @relation(fields: [planId], references: [id], onDelete: SetNull)
  projects Project[]
  forms    Form[]
  wallet   Wallet?

  @@map("teams")
}

model Project {
  id          String    @id @default(uuid()) @db.Uuid
  name        String    @db.Text
  description String?   @db.Text
  teamId      String    @db.Uuid
  valid       Boolean   @default(true) @db.Boolean
  createdAt   DateTime? @db.Timestamptz
  updatedAt   DateTime? @db.Timestamptz

  // Relations
  team  Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)
  forms Form[]

  @@map("projects")
}

model Form {
  id                  String      @id @default(uuid()) @db.Uuid
  name                String      @db.Text
  description         String?     @db.Text
  teamId              String      @db.Uuid
  projectId           String      @db.Uuid
  theme               String?     @db.Text
  logoUrl             String?     @db.Text
  welcomeScreen       Json?       @db.JsonB
  thankYouScreen      Json?       @db.JsonB
  multipleSubmissions Boolean?    @db.Boolean
  maxResponses        Int?
  type                FormType?
  openAt              DateTime?   @db.Timestamptz
  closeAt             DateTime?   @db.Timestamptz
  passwordProtected   Boolean?
  passwordHash        String?     @db.Text
  status              FormStatus?
  requireConsent      Boolean?
  analyticsEnabled    Boolean?
  uniqueSubdomain     String?     @db.Text
  customDomain        String?     @db.Text
  config              Json[]      @db.JsonB
  allowAnonymous      Boolean?
  createdBy           String      @db.Text
  createdAt           DateTime?   @db.Timestamptz
  updatedAt           DateTime?   @db.Timestamptz
  valid               Boolean     @default(true) @db.Boolean

  // Relations
  project   Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  team      Team       @relation(fields: [teamId], references: [id], onDelete: Cascade)
  responses Response[]

  @@map("forms")
}

model Response {
  id           String          @id @default(uuid()) @db.Uuid
  formId       String          @db.Uuid
  userId       String?         @db.Text
  responseData Json            @db.JsonB
  status       ResponseStatus?
  startedAt    DateTime?       @db.Timestamptz
  submittedAt  DateTime?       @db.Timestamptz
  updatedAt    DateTime?       @db.Timestamptz
  partialSave  Boolean?        @db.Boolean
  files        Json?           @db.JsonB
  notified     Boolean?
  ipAddress    String?         @db.Text
  userAgent    String?         @db.Text
  referrerUrl  String?         @db.Text
  tags         String[]
  valid        Boolean         @default(true) @db.Boolean

  // Relations
  form Form @relation(fields: [formId], references: [id], onDelete: Cascade)

  @@map("responses")
}

// #endregion

// #region WALLET, TRANSACTION, PLAN, FEATURE MODELS

model Wallet {
  id                     String    @id @default(cuid()) @db.VarChar(30)
  teamId                 String    @unique @db.Uuid
  balance                Float     @default(0) @db.DoublePrecision
  nonTransferableBalance Float     @default(0) @db.DoublePrecision
  currency               String    @default("INR") @db.VarChar(3)
  currencyRate           Float     @default(1) @db.DoublePrecision
  createdAt              DateTime  @default(now()) @db.Timestamptz
  updatedAt              DateTime? @updatedAt @db.Timestamptz

  // Relations
  transactions Transaction[]
  team         Team          @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@map("wallets")
}

model Transaction {
  id          String          @id @default(cuid()) @db.VarChar(30)
  walletId    String          @db.VarChar(30)
  type        TransactionType
  amount      Float           @db.DoublePrecision
  description String?         @db.Text
  createdAt   DateTime        @default(now()) @db.Timestamptz
  createdBy   String?         @db.VarChar

  // Relations
  wallet Wallet @relation(fields: [walletId], references: [id])

  @@map("transactions")
}

model Plan {
  id          String    @id @default(uuid()) @db.Uuid
  name        String    @db.Text
  description String?   @db.Text
  price       Float     @db.DoublePrecision
  currency    String    @default("INR") @db.VarChar(3)
  valid       Boolean   @default(true) @db.Boolean
  createdAt   DateTime  @default(now()) @db.Timestamptz
  updatedAt   DateTime? @updatedAt @db.Timestamptz

  // Relations
  features Feature[]
  teams    Team[]

  @@map("plans")
}

model Feature {
  id          String    @id @default(uuid()) @db.Uuid
  planId      String    @db.Uuid
  key         String    @db.Text
  name        String?   @db.Text
  description String?   @db.Text
  valid       Boolean   @default(true) @db.Boolean
  createdAt   DateTime  @default(now()) @db.Timestamptz
  updatedAt   DateTime? @updatedAt @db.Timestamptz

  // Relations
  plan Plan @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@map("features")
}

// #endregion

model User {
  id             String  @id @default(cuid()) @db.VarChar(30)
  userName       String  @db.Text
  email          String  @unique @db.Text
  phoneNumber    String? @db.Text
  googleId       String? @unique @db.Text
  profilePicture String? @db.Text
  firstName      String? @db.Text
  lastName       String? @db.Text
  emailVerified  Boolean @default(false)

  createdAt DateTime @default(now()) @db.Timestamptz
  updatedAt DateTime @updatedAt @db.Timestamptz

  @@map("users")
}
